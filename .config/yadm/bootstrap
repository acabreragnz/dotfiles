#!/bin/bash
set -e           # Salir si algún comando falla
set -o pipefail  # Fallar en pipes si algún comando falla

# ==========================================
# Variables Globales
# ==========================================
TOTAL_STEPS=14
CURRENT_STEP=0
APT_UPDATED=false
TEMP_FILES=()
LOG_FILE="$HOME/.config/yadm/bootstrap.log"

# ==========================================
# Sistema de Logging
# ==========================================
# Inicializar log
echo "========================================" >> "$LOG_FILE"
echo "Bootstrap ejecutado: $(date)" >> "$LOG_FILE"
echo "========================================" >> "$LOG_FILE"

log() {
  local level="$1"
  shift
  local message="$*"
  local timestamp=$(date '+%Y-%m-%d %H:%M:%S')
  local log_line="[$timestamp] [$level] $message"
  echo "$log_line" | tee -a "$LOG_FILE"
}

# ==========================================
# Funciones de Control
# ==========================================
step() {
  CURRENT_STEP=$((CURRENT_STEP + 1))
  log "INFO" ">>> PASO $CURRENT_STEP/$TOTAL_STEPS: $*"
}

ensure_apt_updated() {
  if [ "$APT_UPDATED" = false ]; then
    log "INFO" "Actualizando índice apt..."
    sudo apt update
    APT_UPDATED=true
  fi
}

cleanup() {
  if [ ${#TEMP_FILES[@]} -gt 0 ]; then
    log "INFO" "Limpiando archivos temporales..."
    for file in "${TEMP_FILES[@]}"; do
      rm -f "$file" 2>/dev/null
    done
  fi
}

trap cleanup EXIT ERR INT TERM

check_dependencies() {
  local missing_deps=()
  for cmd in wget curl git sudo; do
    if ! command -v "$cmd" >/dev/null 2>&1; then
      missing_deps+=("$cmd")
    fi
  done
  if [ ${#missing_deps[@]} -gt 0 ]; then
    echo "ERROR: Faltan dependencias: ${missing_deps[*]}"
    echo "Instala con: sudo apt install ${missing_deps[*]}"
    exit 1
  fi
}

check_architecture() {
  ARCH=$(dpkg --print-architecture)
  log "INFO" "Arquitectura: $ARCH"
  case "$ARCH" in
    amd64|x86_64)
      log "SUCCESS" "Arquitectura soportada"
      ;;
    arm64|aarch64)
      log "WARNING" "Arquitectura ARM - algunas apps pueden no estar disponibles"
      ;;
    *)
      log "WARNING" "Arquitectura no probada: $ARCH"
      ;;
  esac
}

# Ejecutar verificaciones iniciales
check_dependencies
check_architecture

# ==========================================
# SECCIÓN: Actualización del Sistema
# ==========================================
step "Actualizando sistema"
ensure_apt_updated
sudo apt upgrade -y

# ==========================================
# SECCIÓN: Paquetes Esenciales
# ==========================================
step "Instalando paquetes esenciales"
if [ -f "$HOME/.config/essential-apt-packages.txt" ]; then
  log "INFO" "Instalando paquetes desde essential-apt-packages.txt..."
  cat "$HOME/.config/essential-apt-packages.txt" | grep -v '^#' | grep -v '^$' | xargs sudo apt install -y
fi

# ==========================================
# SECCIÓN: ZSH y Oh-My-Zsh
# ==========================================
step "Instalando Oh-My-Zsh"
if [ ! -d "$HOME/.oh-my-zsh" ]; then
    RUNZSH=no sh -c "$(wget -O- https://raw.githubusercontent.com/ohmyzsh/ohmyzsh/master/tools/install.sh)" "" --unattended
fi

# Definir la ubicación del directorio de plugins de oh-my-zsh
OH_MY_ZSH_CUSTOM="${ZSH_CUSTOM:-$HOME/.oh-my-zsh/custom}/plugins"

# Función para instalar o reinstalar un plugin
install_plugin() {
  local plugin_name="$1"
  local git_repo="$2"
  local plugin_dir="${OH_MY_ZSH_CUSTOM}/${plugin_name}"

  if [ -d "$plugin_dir/.git" ]; then
    log "INFO" "Actualizando plugin ${plugin_name}..."
    (cd "$plugin_dir" && git pull -q) || log "WARNING" "Fallo actualización de ${plugin_name}"
  else
    log "INFO" "Instalando plugin ${plugin_name}..."
    if [ -d "$plugin_dir" ]; then
      rm -rf "$plugin_dir"
    fi
    git clone -q "$git_repo" "$plugin_dir"
  fi
}

# Instalar plugins zsh
install_plugin "zsh-syntax-highlighting" "https://github.com/zsh-users/zsh-syntax-highlighting.git"
install_plugin "zsh-autosuggestions" "https://github.com/zsh-users/zsh-autosuggestions.git"
install_plugin "zsh-npm-scripts-autocomplete" "https://github.com/grigorii-zander/zsh-npm-scripts-autocomplete.git"

# Checkout .zshrc solo si no tiene cambios locales
if [ -f "$HOME/.zshrc" ]; then
  if yadm diff --quiet .zshrc 2>/dev/null; then
    log "INFO" "Aplicando .zshrc desde yadm..."
    yadm checkout .zshrc
  else
    log "WARNING" ".zshrc tiene cambios locales, no se sobrescribirá"
    log "INFO" "Para aplicar la versión de yadm: yadm checkout .zshrc"
  fi
else
  log "INFO" "Aplicando .zshrc desde yadm (fresh install)..."
  yadm checkout .zshrc
fi
# source ~/.zshrc # No se puede ejecutar en script

# Cambiar shell predeterminado a ZSH
if [ "$SHELL" != "$(which zsh)" ]; then
  log "INFO" "Cambiando shell a ZSH..."

  if ! grep -q "^$(which zsh)$" /etc/shells; then
    log "INFO" "Agregando ZSH a /etc/shells..."
    echo "$(which zsh)" | sudo tee -a /etc/shells
  fi

  if chsh -s "$(which zsh)"; then
    log "SUCCESS" "Shell cambiado a ZSH"
  else
    log "WARNING" "No se pudo cambiar shell. Ejecuta: chsh -s $(which zsh)"
  fi
fi

log "SUCCESS" "Instalación de ZSH y plugins completada."

# ==========================================
# SECCIÓN: Node.js y NVM
# ==========================================
step "Instalando NVM y Node.js"
export NVM_DIR="$HOME/.nvm"
if [ ! -d "$NVM_DIR" ]; then
  log "INFO" "Instalando NVM..."
  curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/master/install.sh | bash

  if [ -s "$NVM_DIR/nvm.sh" ]; then
    \. "$NVM_DIR/nvm.sh"
  else
    log "ERROR" "NVM instalado pero nvm.sh no encontrado"
    exit 1
  fi

  if ! command -v nvm >/dev/null 2>&1; then
    log "ERROR" "Comando nvm no disponible después de instalación"
    exit 1
  fi

  nvm install --lts
  nvm alias default node
  log "SUCCESS" "NVM y Node.js LTS instalados"
fi

# ==========================================
# SECCIÓN: PHP
# ==========================================
step "Instalando PHP 8.5 y extensiones"
log "INFO" "Instalando PHP 8.5 y extensiones requeridas..."
# Agregar PPA de Ondrej para PHP 8.5
if ! grep -q "^deb .*ondrej/php" /etc/apt/sources.list /etc/apt/sources.list.d/* 2>/dev/null; then
  sudo add-apt-repository -y ppa:ondrej/php
  sudo apt update
fi
sudo apt install -y php8.5 php8.5-mbstring php8.5-xml php8.5-curl php8.5-zip php8.5-bcmath php8.5-mysql php8.5-sqlite3

# ==========================================
# SECCIÓN: Composer
# ==========================================
step "Instalando Composer"
if ! command -v composer &> /dev/null
then
  log "INFO" "Composer no encontrado. Instalando Composer..."
  php -r "copy('https://getcomposer.org/installer', 'composer-setup.php');"
  sudo php composer-setup.php --install-dir=/usr/local/bin --filename=composer
  php -r "unlink('composer-setup.php');"
  log "SUCCESS" "Composer instalado correctamente."
else
  log "INFO" "Composer ya estaba instalado."
fi

# ==========================================
# SECCIÓN: GitHub CLI
# ==========================================
step "Instalando GitHub CLI"
if ! command -v gh >/dev/null 2>&1; then
  sudo mkdir -p -m 755 /etc/apt/keyrings
  wget -qO- https://cli.github.com/packages/githubcli-archive-keyring.gpg | sudo tee /etc/apt/keyrings/githubcli-archive-keyring.gpg >/dev/null
  sudo chmod go+r /etc/apt/keyrings/githubcli-archive-keyring.gpg
  echo "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/githubcli-archive-keyring.gpg] https://cli.github.com/packages stable main" | sudo tee /etc/apt/sources.list.d/github-cli.list >/dev/null
  sudo apt update && sudo apt install gh -y
  log "SUCCESS" "GitHub CLI instalada."
fi

# ==========================================
# SECCIÓN: AutoKey
# ==========================================
step "Instalando AutoKey"
if ! command -v autokey-gtk >/dev/null 2>&1; then
    log "INFO" "Instalando AutoKey..."
    # Hacer backup temporal de la configuración existente si existe
    if [ -d "$HOME/.config/autokey" ]; then
        mv "$HOME/.config/autokey" "$HOME/.config/autokey.temp"
    fi
    
    # Instalar AutoKey
    ensure_apt_updated
    sudo apt install -y autokey-gtk

    # Restaurar la configuración y limpiar
    if [ -d "$HOME/.config/autokey.temp" ]; then
        rm -rf "$HOME/.config/autokey"
        mv "$HOME/.config/autokey.temp" "$HOME/.config/autokey"
    fi

    # Asegurarse de que los permisos están correctos
    chmod -R u+rw "$HOME/.config/autokey"

    # Iniciar AutoKey en segundo plano
    nohup autokey-gtk >/dev/null 2>&1 &
    # Configurar autostart para AutoKey
    mkdir -p "$HOME/.config/autostart"
    cat > "$HOME/.config/autostart/autokey.desktop" << EOL
[Desktop Entry]
Type=Application
Name=AutoKey
Exec=autokey-gtk
Hidden=false
NoDisplay=false
X-GNOME-Autostart-enabled=true
EOL
    log "SUCCESS" "AutoKey instalado, configurado y añadido al inicio automático."
else
    # Asegurar que autostart está configurado incluso si AutoKey ya estaba instalado
    mkdir -p "$HOME/.config/autostart"
    cat > "$HOME/.config/autostart/autokey.desktop" << EOL
[Desktop Entry]
Type=Application
Name=AutoKey
Exec=autokey-gtk
Hidden=false
NoDisplay=false
X-GNOME-Autostart-enabled=true
EOL
    log "INFO" "AutoKey ya está instalado. Configuración de inicio automático actualizada."
fi

# ==========================================
# SECCIÓN: Aplicaciones de Terceros
# ==========================================
step "Instalando aplicaciones de terceros"

# Descargar e instalar aplicaciones de terceros solo si no están ya instaladas
check_and_install_app() {
  local app_name="$1"
  local app_command="$2"
  local download_url="$3"
  local deb_name="$4"

  if ! command -v "$app_command" >/dev/null 2>&1; then
    log "INFO" "Descargando $app_name..."
    TEMP_FILES+=("$deb_name")

    if ! wget -q --show-progress "$download_url" -O "$deb_name"; then
      log "ERROR" "Fallo descarga de $app_name"
      return 1
    fi

    if [ ! -s "$deb_name" ]; then
      log "ERROR" "Archivo $deb_name vacío"
      return 1
    fi

    if sudo dpkg -i "$deb_name"; then
      log "SUCCESS" "$app_name instalado"
    else
      log "ERROR" "Fallo instalación de $app_name"
      return 1
    fi
  else
    log "INFO" "$app_name ya instalado"
  fi
}

check_and_install_app "Warp" "warp-terminal" "https://app.warp.dev/download?package=deb" "warp.deb"
check_and_install_app "VSCode" "code" "https://update.code.visualstudio.com/latest/linux-deb-x64/stable" "vscode.deb"
check_and_install_app "Cursor" "cursor" "https://www.cursor.com/api/download?platform=linux-x64&releaseTrack=stable" "cursor.deb"
check_and_install_app "Google Chrome" "google-chrome" "https://dl.google.com/linux/direct/google-chrome-stable_current_amd64.deb" "chrome.deb"

# Corregir posibles dependencias faltantes después de la instalación
sudo apt install -f -y

# ==========================================
# SECCIÓN: Configuración MIME Types
# ==========================================
step "Configurando editor predeterminado"
log "INFO" "Configurando editor predeterminado para archivos de código..."

# Lista de tipos MIME para archivos de código
MIME_TYPES=(
  "text/plain"
  "text/x-python"
  "text/javascript"
  "application/javascript"
  "application/x-javascript"
  "text/x-java"
  "text/x-c"
  "text/x-c++"
  "application/json"
  "text/x-markdown"
  "text/html"
  "text/css"
  "application/x-yaml"
  "text/x-sh"
  "application/x-shellscript"
  "text/x-php"
  "application/x-php"
  "text/x-ruby"
  "application/x-ruby"
  "text/x-go"
  "text/x-rust"
  "text/x-dockerfile"
  "text/typescript"
  "application/typescript"
  "text/x-typescript"
  "text/x-tsx"
  "text/vnd.trolltech.linguist"
)

# Función para configurar MIME types
configure_mime_types() {
  local desktop_file="$1"
  local editor_name="$2"

  log "INFO" "Configurando $editor_name como editor predeterminado..."
  for mime_type in "${MIME_TYPES[@]}"; do
    xdg-mime default "$desktop_file" "$mime_type"
  done
  log "SUCCESS" "$editor_name configurado como editor predeterminado para archivos de código."
}

# Detectar y configurar el mejor editor disponible
if command -v cursor >/dev/null 2>&1; then
  configure_mime_types "cursor.desktop" "Cursor"
elif command -v code >/dev/null 2>&1; then
  configure_mime_types "code.desktop" "VSCode"
else
  log "WARNING" "Ni Cursor ni VSCode están instalados. Manteniendo editor predeterminado del sistema."
fi

# ==========================================
# SECCIÓN: Configuración GNOME
# ==========================================
step "Configurando GNOME"
log "INFO" "Configurando GNOME..."

# Tema oscuro
dconf write /org/gnome/desktop/interface/color-scheme "'prefer-dark'"

# Teclado US + US International
dconf write /org/gnome/desktop/input-sources/sources "[('xkb', 'us'), ('xkb', 'us+intl')]"

# Registrar atajos personalizados
dconf write /org/gnome/settings-daemon/plugins/media-keys/custom-keybindings "['/org/gnome/settings-daemon/plugins/media-keys/custom-keybindings/claude/', '/org/gnome/settings-daemon/plugins/media-keys/custom-keybindings/flameshot/', '/org/gnome/settings-daemon/plugins/media-keys/custom-keybindings/warp/']"

# Super+C → Claude
dconf write /org/gnome/settings-daemon/plugins/media-keys/custom-keybindings/claude/binding "'<Super>c'"
dconf write /org/gnome/settings-daemon/plugins/media-keys/custom-keybindings/claude/command "'gtk-launch claude-desktop 2>/dev/null || claude'"
dconf write /org/gnome/settings-daemon/plugins/media-keys/custom-keybindings/claude/name "'Claude'"

# Print → Flameshot
dconf write /org/gnome/settings-daemon/plugins/media-keys/custom-keybindings/flameshot/binding "'Print'"
dconf write /org/gnome/settings-daemon/plugins/media-keys/custom-keybindings/flameshot/command "'flameshot gui'"
dconf write /org/gnome/settings-daemon/plugins/media-keys/custom-keybindings/flameshot/name "'Flameshot'"

# Super+Return → Warp
dconf write /org/gnome/settings-daemon/plugins/media-keys/custom-keybindings/warp/binding "'<Super>Return'"
dconf write /org/gnome/settings-daemon/plugins/media-keys/custom-keybindings/warp/command "'warp-terminal'"
dconf write /org/gnome/settings-daemon/plugins/media-keys/custom-keybindings/warp/name "'Warp Terminal'"

# Dock
dconf write /org/gnome/shell/extensions/dash-to-dock/dash-max-icon-size 38
dconf write /org/gnome/shell/extensions/dash-to-dock/multi-monitor true

log "SUCCESS" "GNOME configurado."

# ==========================================
# SECCIÓN: Snaps
# ==========================================
step "Instalando snaps esenciales"
if [ -f "$HOME/.config/essential-snaps.txt" ]; then
  log "INFO" "Instalando snaps desde essential-snaps.txt..."
  cat "$HOME/.config/essential-snaps.txt" | grep -v '^#' | grep -v '^$' | xargs -L 1 sudo snap install
fi

# ==========================================
# SECCIÓN: Limpieza del Sistema
# ==========================================
step "Limpiando sistema"
log "INFO" "Limpiando archivos temporales y caché de apt..."
sudo apt autoremove -y
sudo apt autoclean -y
log "SUCCESS" "Limpieza de sistema completada."

# ==========================================
# SECCIÓN: Hardening de Seguridad
# ==========================================
step "Aplicando configuraciones de seguridad"
log "INFO" "Aplicando configuraciones de seguridad..."

# Configuraciones de GNOME (no requiere sudo)
if [ -f "$HOME/.config/yadm/scripts/gnome-security-settings.sh" ]; then
  bash "$HOME/.config/yadm/scripts/gnome-security-settings.sh"
fi

# Hardening completo (ejecutar con sudo después si es necesario)
if [ -f "$HOME/.config/yadm/scripts/security-hardening.sh" ]; then
  bash "$HOME/.config/yadm/scripts/security-hardening.sh"
fi

# Autenticación biométrica (huella dactilar)
log "INFO" "Configurando autenticación biométrica..."
if [ -f "$HOME/.config/yadm/scripts/setup-fingerprint-auth.sh" ]; then
  # Ejecutar con --skip-enroll para no re-registrar si ya existen huellas
  bash "$HOME/.config/yadm/scripts/setup-fingerprint-auth.sh" --skip-enroll
else
  log "WARNING" "Script de fingerprint no encontrado, saltando..."
fi

log "SUCCESS" "Configuraciones de seguridad aplicadas."

echo ""
echo "=============================================="
log "SUCCESS" "Instalación completada."
echo "=============================================="
echo ""
echo "NOTA IMPORTANTE - Seguridad:"
echo "Para aplicar política de contraseñas (requiere sudo):"
echo "  sudo bash ~/.config/yadm/scripts/security-hardening.sh"
echo ""
echo "Ver política completa: cat ~/.config/security-policy.conf"
echo ""
