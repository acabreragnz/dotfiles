#!/bin/bash

# Actualizar el sistema
sudo apt update && sudo apt upgrade -y

# Instalar paquetes esenciales
sudo apt install -y git curl zsh fonts-powerline gnome-tweaks fonts-cascadia-code software-properties-common

# Instalar paquetes esenciales desde archivo
if [ -f "$HOME/.config/essential-apt-packages.txt" ]; then
  echo "Instalando paquetes desde essential-apt-packages.txt..."
  cat "$HOME/.config/essential-apt-packages.txt" | grep -v '^#' | grep -v '^$' | xargs sudo apt install -y
fi

# Instalar oh-my-zsh de manera no interactiva
if [ ! -d "$HOME/.oh-my-zsh" ]; then
    RUNZSH=no sh -c "$(wget -O- https://raw.githubusercontent.com/ohmyzsh/ohmyzsh/master/tools/install.sh)" "" --unattended
fi

# Definir la ubicación del directorio de plugins de oh-my-zsh
OH_MY_ZSH_CUSTOM="${ZSH_CUSTOM:-$HOME/.oh-my-zsh/custom}/plugins"

# Función para instalar o reinstalar un plugin
install_plugin() {
  local plugin_name="$1"
  local git_repo="$2"
  local plugin_dir="${OH_MY_ZSH_CUSTOM}/${plugin_name}"

  if [ -d "$plugin_dir" ]; then
    echo "El plugin ${plugin_name} ya está instalado. Reinstalándolo."
    rm -rf "$plugin_dir"
  fi

  git clone "$git_repo" "$plugin_dir"
  echo "Plugin ${plugin_name} clonado correctamente."
}

# Instalar plugins zsh
install_plugin "zsh-syntax-highlighting" "https://github.com/zsh-users/zsh-syntax-highlighting.git"
install_plugin "zsh-autosuggestions" "https://github.com/zsh-users/zsh-autosuggestions.git"
install_plugin "zsh-npm-scripts-autocomplete" "https://github.com/grigorii-zander/zsh-npm-scripts-autocomplete.git"

yadm checkout .zshrc
# source ~/.zshrc # No se puede ejecutar en script

# Cambiar shell predeterminado a ZSH
if [ "$SHELL" != "$(which zsh)" ]; then
  echo "Cambiando shell predeterminado a ZSH..."
  chsh -s $(which zsh)
  echo "Shell cambiado a ZSH. Necesitarás cerrar sesión y volver a entrar para que tome efecto."
fi

echo "Instalación de ZSH y plugins completada. Por favor, reinicia tu terminal."

# Instalar NVM, Node.js LTS y configurar el entorno NVM
export NVM_DIR="$HOME/.nvm"
if [ ! -d "$NVM_DIR" ]; then
  curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.39.1/install.sh | bash
  \. "$NVM_DIR/nvm.sh"
  nvm install --lts
  nvm alias default node
  echo "NVM y Node.js LTS instalados."
fi

echo "Instalando PHP 8.5 y extensiones requeridas..."
# Agregar PPA de Ondrej para PHP 8.5
if ! grep -q "^deb .*ondrej/php" /etc/apt/sources.list /etc/apt/sources.list.d/* 2>/dev/null; then
  sudo add-apt-repository -y ppa:ondrej/php
  sudo apt update
fi
sudo apt install -y php8.5 php8.5-mbstring php8.5-xml php8.5-curl php8.5-zip php8.5-bcmath php8.5-mysql php8.5-sqlite3

# Instalar Composer globalmente
if ! command -v composer &> /dev/null
then
  echo "Composer no encontrado. Instalando Composer..."
  php -r "copy('https://getcomposer.org/installer', 'composer-setup.php');"
  sudo php composer-setup.php --install-dir=/usr/local/bin --filename=composer
  php -r "unlink('composer-setup.php');"
  echo "Composer instalado correctamente."
else
  echo "Composer ya estaba instalado."
fi

# Instalar la CLI de GitHub si no está ya instalada
if ! command -v gh >/dev/null 2>&1; then
  sudo mkdir -p -m 755 /etc/apt/keyrings
  wget -qO- https://cli.github.com/packages/githubcli-archive-keyring.gpg | sudo tee /etc/apt/keyrings/githubcli-archive-keyring.gpg >/dev/null
  sudo chmod go+r /etc/apt/keyrings/githubcli-archive-keyring.gpg
  echo "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/githubcli-archive-keyring.gpg] https://cli.github.com/packages stable main" | sudo tee /etc/apt/sources.list.d/github-cli.list >/dev/null
  sudo apt update && sudo apt install gh -y
  echo "GitHub CLI instalada."
fi

# Instalar AutoKey si no está instalado
if ! command -v autokey-gtk >/dev/null 2>&1; then
    echo "Instalando AutoKey..."
    # Hacer backup temporal de la configuración existente si existe
    if [ -d "$HOME/.config/autokey" ]; then
        mv "$HOME/.config/autokey" "$HOME/.config/autokey.temp"
    fi
    
    # Instalar AutoKey
    sudo apt install -y autokey-gtk
    
    # Restaurar la configuración y limpiar
    if [ -d "$HOME/.config/autokey.temp" ]; then
        rm -rf "$HOME/.config/autokey"
        mv "$HOME/.config/autokey.temp" "$HOME/.config/autokey"
    fi
    
    # Asegurarse de que los permisos están correctos
    chmod -R u+rw "$HOME/.config/autokey"
    
    # Iniciar AutoKey en segundo plano
    nohup autokey-gtk >/dev/null 2>&1 &
    # Configurar autostart para AutoKey
    mkdir -p "$HOME/.config/autostart"
    cat > "$HOME/.config/autostart/autokey.desktop" << EOL
[Desktop Entry]
Type=Application
Name=AutoKey
Exec=autokey-gtk
Hidden=false
NoDisplay=false
X-GNOME-Autostart-enabled=true
EOL
    echo "AutoKey instalado, configurado y añadido al inicio automático."
else
    # Asegurar que autostart está configurado incluso si AutoKey ya estaba instalado
    mkdir -p "$HOME/.config/autostart"
    cat > "$HOME/.config/autostart/autokey.desktop" << EOL
[Desktop Entry]
Type=Application
Name=AutoKey
Exec=autokey-gtk
Hidden=false
NoDisplay=false
X-GNOME-Autostart-enabled=true
EOL
    echo "AutoKey ya está instalado. Configuración de inicio automático actualizada."
fi

# Descargar e instalar aplicaciones de terceros solo si no están ya instaladas
check_and_install_app() {
  local app_name="$1"
  local app_command="$2"
  local download_url="$3"
  local deb_name="$4"

  if ! command -v "$app_command" >/dev/null 2>&1; then
    wget "$download_url" -O "$deb_name" && sudo dpkg -i "$deb_name" && rm "$deb_name"
    echo "$app_name instalado."
  else
    echo "$app_name ya está instalado."
  fi
}

check_and_install_app "Warp" "warp-terminal" "https://app.warp.dev/download?package=deb" "warp.deb"
check_and_install_app "VSCode" "code" "https://update.code.visualstudio.com/latest/linux-deb-x64/stable" "vscode.deb"
check_and_install_app "Cursor" "cursor" "https://api2.cursor.sh/updates/download/golden/linux-x64-deb/cursor/2.4" "cursor.deb"
check_and_install_app "Google Chrome" "google-chrome" "https://dl.google.com/linux/direct/google-chrome-stable_current_amd64.deb" "chrome.deb"

# Corregir posibles dependencias faltantes después de la instalación
sudo apt install -f -y

# Configurar editor predeterminado para archivos de código
echo "Configurando editor predeterminado para archivos de código..."

# Lista de tipos MIME para archivos de código
MIME_TYPES=(
  "text/plain"
  "text/x-python"
  "text/javascript"
  "application/javascript"
  "application/x-javascript"
  "text/x-java"
  "text/x-c"
  "text/x-c++"
  "application/json"
  "text/x-markdown"
  "text/html"
  "text/css"
  "application/x-yaml"
  "text/x-sh"
  "application/x-shellscript"
  "text/x-php"
  "application/x-php"
  "text/x-ruby"
  "application/x-ruby"
  "text/x-go"
  "text/x-rust"
  "text/x-dockerfile"
  "text/typescript"
  "application/typescript"
  "text/x-typescript"
  "text/x-tsx"
  "text/vnd.trolltech.linguist"
)

# Función para configurar MIME types
configure_mime_types() {
  local desktop_file="$1"
  local editor_name="$2"
  
  echo "Configurando $editor_name como editor predeterminado..."
  for mime_type in "${MIME_TYPES[@]}"; do
    xdg-mime default "$desktop_file" "$mime_type"
  done
  echo "$editor_name configurado como editor predeterminado para archivos de código."
}

# Detectar y configurar el mejor editor disponible
if command -v cursor >/dev/null 2>&1; then
  configure_mime_types "cursor.desktop" "Cursor"
elif command -v code >/dev/null 2>&1; then
  configure_mime_types "code.desktop" "VSCode"
else
  echo "Ni Cursor ni VSCode están instalados. Manteniendo editor predeterminado del sistema."
fi

# Configurar GNOME (solo settings específicos, no destructivo)
echo "Configurando GNOME..."

# Tema oscuro
dconf write /org/gnome/desktop/interface/color-scheme "'prefer-dark'"

# Teclado US + US International
dconf write /org/gnome/desktop/input-sources/sources "[('xkb', 'us'), ('xkb', 'us+intl')]"

# Registrar atajos personalizados
dconf write /org/gnome/settings-daemon/plugins/media-keys/custom-keybindings "['/org/gnome/settings-daemon/plugins/media-keys/custom-keybindings/claude/', '/org/gnome/settings-daemon/plugins/media-keys/custom-keybindings/flameshot/', '/org/gnome/settings-daemon/plugins/media-keys/custom-keybindings/warp/']"

# Super+C → Claude
dconf write /org/gnome/settings-daemon/plugins/media-keys/custom-keybindings/claude/binding "'<Super>c'"
dconf write /org/gnome/settings-daemon/plugins/media-keys/custom-keybindings/claude/command "'gtk-launch claude-desktop 2>/dev/null || claude'"
dconf write /org/gnome/settings-daemon/plugins/media-keys/custom-keybindings/claude/name "'Claude'"

# Print → Flameshot
dconf write /org/gnome/settings-daemon/plugins/media-keys/custom-keybindings/flameshot/binding "'Print'"
dconf write /org/gnome/settings-daemon/plugins/media-keys/custom-keybindings/flameshot/command "'flameshot gui'"
dconf write /org/gnome/settings-daemon/plugins/media-keys/custom-keybindings/flameshot/name "'Flameshot'"

# Super+Return → Warp
dconf write /org/gnome/settings-daemon/plugins/media-keys/custom-keybindings/warp/binding "'<Super>Return'"
dconf write /org/gnome/settings-daemon/plugins/media-keys/custom-keybindings/warp/command "'warp-terminal'"
dconf write /org/gnome/settings-daemon/plugins/media-keys/custom-keybindings/warp/name "'Warp Terminal'"

# Dock
dconf write /org/gnome/shell/extensions/dash-to-dock/dash-max-icon-size 38
dconf write /org/gnome/shell/extensions/dash-to-dock/multi-monitor true

echo "GNOME configurado."

# Instalar snaps esenciales desde archivo
if [ -f "$HOME/.config/essential-snaps.txt" ]; then
  echo "Instalando snaps desde essential-snaps.txt..."
  cat "$HOME/.config/essential-snaps.txt" | grep -v '^#' | grep -v '^$' | xargs -L 1 sudo snap install
fi

# Limpiar archivos temporales y la caché de apt
sudo apt autoremove -y
sudo apt autoclean -y
echo "Limpieza de sistema completada."

echo "Instalación completada."
